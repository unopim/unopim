name: Pest Tests

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  pest_tests:
    runs-on: ubuntu-latest

    name: PHP 8.2 Pest Tests

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: unopim
        ports:
          - 3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: curl, fileinfo, gd, intl, mbstring, openssl, pdo, pdo_mysql, tokenizer, zip
          tools: composer:v2
          ini-values: |
            memory_limit=1024M
            error_reporting=E_ALL

      - name: Install Composer dependencies
        run: |
          composer install \
            --no-interaction \
            --prefer-dist \
            --optimize-autoloader


      - name: Prepare environment file
        run: |
          cp .env.example .env
          sed -i "s/^APP_ENV=.*/APP_ENV=testing/" .env
          sed -i "s/^DB_HOST=.*/DB_HOST=127.0.0.1/" .env
          sed -i "s/^DB_PORT=.*/DB_PORT=${{ job.services.mysql.ports['3306'] }}/" .env
          sed -i "s/^DB_DATABASE=.*/DB_DATABASE=unopim/" .env
          sed -i "s/^DB_USERNAME=.*/DB_USERNAME=root/" .env
          sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=root/" .env


      - name: Run UnoPim installer
        run: php artisan unopim:install --skip-env-check --skip-admin-creation


      - name: Run Pest tests
        env:
          CI: true
        run: |
          vendor/bin/pest \
            --parallel \
            --processes=2 \
            --colors=always


      - name: Debug memory & kernel logs (on failure)
        if: failure()
        run: |
          echo "===== MEMORY ====="
          free -h
          echo "===== KERNEL LOG ====="
          dmesg | tail -n 50 || true
